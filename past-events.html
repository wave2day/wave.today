<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Past Events</title>

  <style>
    html,body{
      margin:0;
      padding:0;
      background:#07070c;
      color:#eef0ff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }

    /* ===== Ambient background (bez videa) ===== */
    #ambientBg{
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(1200px 700px at 50% 18%, rgba(120,150,255,.14), transparent 60%),
        radial-gradient(900px 600px at 18% 72%, rgba(255,120,210,.08), transparent 62%),
        radial-gradient(1100px 700px at 80% 78%, rgba(90,255,220,.06), transparent 66%),
        linear-gradient(180deg, #0b0b16, #05050a);
      transition: filter .35s ease;
    }
    #ambientGlow{
      position:fixed;
      inset:-12vh;
      z-index:-1;
      pointer-events:none;
      background: radial-gradient(circle at 50% 45%, rgba(120,150,255,.35), transparent 58%);
      filter: blur(18px) saturate(1.15);
      opacity:.95;
      transition: background .55s ease, opacity .55s ease;
    }

    /* ===== Page glass ===== */
    .glassPage{
      min-height: 100vh;
      padding: 18px 18px 80px;
      background: rgba(255,255,255,.055);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
    }

    .topBar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: calc(env(safe-area-inset-top) + 12px) 0 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
    }
    .titleMini{
      font-weight: 900;
      letter-spacing: .6px;
      color: rgba(255,255,255,.88);
      text-shadow: 0 14px 36px rgba(0,0,0,.55);
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Grid plakátů ===== */
    #eventsGrid{
      max-width: 1180px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
      gap: 28px;
      padding-top: 10px;
    }

    .posterCard{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      transform: translateZ(0);
      text-decoration:none;
      color:inherit;
      display:block;
    }
    .posterCard img{
      width:100%;
      height:auto;
      display:block;
    }
    .cap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: 12px 12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.62));
      color:#fff;
    }
    .capTitle{ font-weight: 900; letter-spacing: .25px; text-transform: lowercase; }
    .capDate{ opacity:.88; font-size: 12px; }

    .err{
      max-width: 980px;
      margin: 18px auto 0;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
    }

    /* ===== WT pill (Main Page) — engine převzatý z oknoGIT.html ===== */
    #wtMainPill{
      --outer: 190px;
      --innerRatio: .65;
      --pillW: 440px;

      --glassClearA: rgba(255,255,255,.14);
      --glassClearB: rgba(255,255,255,.08);
      --glassMilkA:  rgba(255,255,255,.10);
      --glassMilkB:  rgba(255,255,255,.12);

      --pressY: 3px;
      --pressTimeIn: 110ms;
      --pressTimeOut: 190ms;

      --textColor: rgba(255,255,255,.92);
      --textSize: 34px;
      --textScaleX: 1.10;
      --textWidth: 92%;

      --stroke: rgba(0,0,0,.34);
      --depth1: rgba(0,0,0,.30);
      --depth2: rgba(0,0,0,.18);
      --lacquer: rgba(255,255,255,.28);

      /* měřítko pro topBar */
      --pillScale: .253;
      display:flex;
      align-items:center;
      flex: 0 0 auto;
    }
    #wtMainPill *{ box-sizing:border-box; }
    #wtMainPill .glassBase{
      --w: var(--outer);
      --h: var(--outer);
      --r: 50%;
      --smearInset: 10px;

      width: var(--w);
      height: var(--h);
      border-radius: var(--r);
      position: relative;
      display:grid;
      place-items:center;
      isolation:isolate;

      background:
        radial-gradient(120% 120% at 50% 60%, var(--glassMilkA), transparent 62%),
        radial-gradient(120% 120% at 50% 92%, var(--glassMilkB), transparent 58%),
        radial-gradient(120% 120% at 35% 25%, var(--glassClearA), transparent 55%),
        radial-gradient(140% 140% at 65% 70%, var(--glassClearB), transparent 60%),
        rgba(255,255,255,.08);

      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.10);

      /* scale down */
      zoom: var(--pillScale);
      transform-origin: left top;
    }
    @supports not (zoom: 1){
      #wtMainPill .glassBase{ zoom:1; transform: scale(var(--pillScale)); }
    }

    #wtMainPill .pressGlow{
      position:absolute;
      inset:0;
      border-radius: inherit;
      background:
        radial-gradient(120% 120% at 50% 70%, rgba(255,255,255,.22), transparent 58%),
        radial-gradient(120% 120% at 50% 90%, rgba(0,0,0,.22), transparent 62%);
      opacity:0;
      transform: scale(.98);
      transition: opacity var(--pressTimeOut) ease, transform var(--pressTimeOut) ease;
      z-index: 1;
      pointer-events:none;
    }

    #wtMainPill .coreBtn{
      position: relative;
      border: none;
      background: none;
      padding: 0;
      margin: 0;

      display:grid;
      place-items:center;
      text-decoration:none;
      cursor:pointer;
    }

    #wtMainPill .pill{
      --w: var(--pillW);
      --h: var(--outer);
      --r: calc(var(--outer)/2);
      --gap: calc(var(--outer) * (1 - var(--innerRatio)) / 2);
      width: var(--w);
      height: var(--h);
      border-radius: var(--r);
    }
    #wtMainPill .pill .coreBtn{
      width: calc(var(--pillW) - (2 * var(--gap)));
      height: calc(var(--outer) * var(--innerRatio));
      border-radius: calc((var(--outer) * var(--innerRatio)) / 2);
      box-shadow:
        0 18px 26px rgba(0,0,0,.18),
        inset 0 16px 22px rgba(0,0,0,.13),
        inset 0 -14px 20px rgba(255,255,255,.14);
      transition:
        transform var(--pressTimeOut) cubic-bezier(.2,.8,.2,1),
        box-shadow var(--pressTimeOut) ease,
        filter var(--pressTimeOut) ease;
      filter: brightness(.99) saturate(.98);
    }

    #wtMainPill .v-blue{
      --c1:#6f7ed0; --c2:#5462bb; --c3:#4a57ae;
    }
    #wtMainPill .glassBase.v-blue{
      background:
        radial-gradient(140% 120% at 26% 18%, rgba(255,255,255,.16), transparent 52%),
        radial-gradient(120% 120% at 60% 86%, rgba(255,255,255,.10), transparent 58%),
        radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.10), transparent 62%),
        radial-gradient(130% 130% at 50% 60%, rgba(111,126,208,.18), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    #wtMainPill .glassBase:has(.coreBtn:active){
      filter: brightness(.985);
      transition: filter var(--pressTimeIn) ease;
    }
    #wtMainPill .glassBase:has(.coreBtn:active) .pressGlow{
      opacity:1;
      transform: scale(1.01);
      transition: opacity var(--pressTimeIn) ease, transform var(--pressTimeIn) ease;
    }
    #wtMainPill .coreBtn:active{
      transform: translateY(var(--pressY));
      transition:
        transform var(--pressTimeIn) cubic-bezier(.2,.8,.2,1),
        box-shadow var(--pressTimeIn) ease,
        filter var(--pressTimeIn) ease;
      box-shadow:
        0 10px 18px rgba(0,0,0,.16),
        inset 0 20px 26px rgba(0,0,0,.18),
        inset 0 -10px 16px rgba(255,255,255,.10);
      filter: brightness(.99) saturate(.98);
    }

    #wtMainPill .coreText{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;

      width: var(--textWidth);
      margin: 0 auto;

      color: var(--textColor);
      font-weight: 720;
      font-size: var(--textSize);
      letter-spacing: .55px;
      line-height: 1;
      text-transform: lowercase;

      transform: scaleX(var(--textScaleX));
      transform-origin: center;

      text-shadow:
        -0.75px 0      0 var(--stroke),
         0.75px 0      0 var(--stroke),
         0      -0.75px 0 var(--stroke),
         0       0.75px 0 var(--stroke),
        -0.55px -0.55px 0 var(--stroke),
         0.55px -0.55px 0 var(--stroke),
        -0.55px  0.55px 0 var(--stroke),
         0.55px  0.55px 0 var(--stroke),
        0 -0.55px 0 var(--lacquer),
        0  1.25px 1.45px var(--depth1),
        0  3px    8px    var(--depth2);
    }
  </style>
</head>
<body>
  <div id="ambientBg"></div>
  <div id="ambientGlow"></div>

  <div class="glassPage">
    <div class="topBar">
      <div id="wtMainPill" aria-label="Main page">
        <div class="glassBase pill v-blue">
          <div class="pressGlow"></div>
          <a class="coreBtn" href="index.html" aria-label="Main page">
            <span class="coreText">main page</span>
          </a>
        </div>
      </div>

      <div class="titleMini">past events</div>
    </div>

    <div id="eventsGrid" aria-label="Seznam plakátů"></div>
  </div>

<script>
(() => {
  const DATA_URL = 'assets/data/events.json';
  const grid = document.getElementById('eventsGrid');
  const glow = document.getElementById('ambientGlow');

  const colorCache = new Map(); // src -> rgba string

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function rgba(r,g,b,a){ return `rgba(${r|0},${g|0},${b|0},${a})`; }

  function colorFromText(str){
    let h=0;
    for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
    const r = 70 + (h % 160);
    const g = 70 + ((h>>8) % 160);
    const b = 70 + ((h>>16) % 160);
    return rgba(r,g,b,0.42);
  }

  async function avgColorFromImage(img){
    const src = img.currentSrc || img.src;
    if(colorCache.has(src)) return colorCache.get(src);

    try{
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      const w = 32, h = 32;
      canvas.width = w; canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      const data = ctx.getImageData(0,0,w,h).data;

      let rs=0, gs=0, bs=0, ws=0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3]/255;
        if(a < 0.15) continue;
        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        const sat = (max - min) / (max || 1);
        const wgt = a * (0.35 + sat*0.95);
        rs += r*wgt; gs += g*wgt; bs += b*wgt; ws += wgt;
      }
      if(ws <= 0.0001) throw new Error('no pixels');

      const r = clamp(rs/ws, 0, 255);
      const g = clamp(gs/ws, 0, 255);
      const b = clamp(bs/ws, 0, 255);

      const c = rgba(r,g,b,0.42);
      colorCache.set(src, c);
      return c;
    }catch(e){
      const fallback = colorFromText(img.alt || src);
      colorCache.set(src, fallback);
      return fallback;
    }
  }

  function setGlow(colorRgba){
    glow.style.background = `radial-gradient(circle at 50% 45%, ${colorRgba}, transparent 58%)`;
  }

  function parseDate(d){
    const [y,m,dd] = (d||'').split('-').map(Number);
    return new Date(y||1970, (m||1)-1, dd||1, 12, 0, 0);
  }

  async function loadEvents(){
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    if(!res.ok) throw new Error('events.json not found');
    const all = await res.json();

    const today = new Date();
    today.setHours(0,0,0,0);

    const past = all
      .filter(e => e && e.date && parseDate(e.date) < today)
      .sort((a,b) => parseDate(b.date) - parseDate(a.date));

    if(!past.length){
      grid.innerHTML = '<div class="err">Žádné minulá data v events.json.</div>';
      return;
    }

    grid.innerHTML = past.map(e => {
      const title = (e.title || '').trim() || (e.image || '').split('/').pop();
      const img = e.image || '';
      const date = e.date || '';
      const link = (e.link || '').trim();
      const tag = link ? 'a' : 'div';
      const extra = link ? ` href="${link}" target="_blank" rel="noopener"` : '';
      return `
        <${tag} class="posterCard" data-date="${date}" data-title="${title}"${extra}>
          <img loading="lazy" decoding="async" src="${img}" alt="${title}">
          <div class="cap">
            <span class="capTitle">${title.toLowerCase()}</span>
            <span class="capDate">${date}</span>
          </div>
        </${tag}>
      `;
    }).join('');

    const imgs = Array.from(grid.querySelectorAll('.posterCard img'));

    const firstImg = imgs[0];
    if(firstImg){
      if(firstImg.complete){
        setGlow(await avgColorFromImage(firstImg));
      }else{
        setGlow(colorFromText(firstImg.alt || 'event'));
        firstImg.addEventListener('load', async () => setGlow(await avgColorFromImage(firstImg)), { once:true });
      }
    }

    let raf = 0;
    async function update(){
      raf = 0;
      const center = window.innerHeight / 2;
      let bestImg = null;
      let bestDist = Infinity;

      for(const img of imgs){
        const r = img.getBoundingClientRect();
        const c = r.top + r.height/2;
        const d = Math.abs(center - c);
        if(d < bestDist){
          bestDist = d;
          bestImg = img;
        }
      }
      if(!bestImg) return;

      if(!bestImg.complete){
        setGlow(colorFromText(bestImg.alt || 'event'));
        bestImg.addEventListener('load', async () => setGlow(await avgColorFromImage(bestImg)), { once:true });
        return;
      }

      setGlow(await avgColorFromImage(bestImg));
    }

    function schedule(){
      if(raf) return;
      raf = requestAnimationFrame(update);
    }

    window.addEventListener('scroll', schedule, { passive:true });
    window.addEventListener('resize', schedule);
    schedule();
  }

  loadEvents().catch(err => {
    console.error(err);
    grid.innerHTML = '<div class="err">Nepodařilo se načíst assets/data/events.json. Zkontroluj cestu a commit.</div>';
  });
})();
</script>
</body>
</html>
