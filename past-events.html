<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Past Events</title>

  <style>
    
*{box-sizing:border-box;}
html,body{
      margin:0;
      padding:0;
      background:transparent;
      color:#eef0ff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      position:relative;
      overflow-x:hidden;
    }

    #pageBase{
      position:fixed;
      inset:0;
      z-index:0;
      background:#0b0b10;
      pointer-events:none;
    }
    a,button{ -webkit-tap-highlight-color: transparent; }
    a:focus, a:focus-visible, button:focus, button:focus-visible{ outline: none !important; box-shadow:none !important; }


    /* ===== Ambient background (bez videa) ===== */
    #ambientBg{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;
      --ambR: 145; --ambG: 85; --ambB: 255; /* fallback purple */
      background:
        radial-gradient(1100px 720px at 52% 16%, rgba(var(--ambR),var(--ambG),var(--ambB),.30), transparent 62%),
        radial-gradient(820px 520px at 18% 62%, rgba(80,150,255,.18), transparent 60%),
        radial-gradient(820px 520px at 86% 70%, rgba(255,70,205,.14), transparent 60%),
        linear-gradient(180deg, #0b0b10, #0b0b10);
      transition: filter .35s ease, background .45s ease;
    }

    #ambientPoster{
      position:fixed;
      inset:-14vh;
      z-index:2;
      pointer-events:none;
      background: none;
      background-size: cover;
      background-position: center;
      filter: blur(86px) saturate(1.15);
      opacity:.10;
      transform: scale(1.06);
      mix-blend-mode: screen;
      transition: background-image .55s ease, opacity .55s ease;
    }

    #ambientGlow{
      position:fixed;
      inset:-12vh;
      z-index:3;
      pointer-events:none;
      background: radial-gradient(circle at 50% 45%, rgba(120,150,255,.35), transparent 58%);
      filter: blur(20px) saturate(1.25);
      mix-blend-mode: screen;
      opacity:.98;
      transition: background .55s ease, opacity .55s ease;
    }

    
@keyframes wtAmbientDrift{
  0%{ transform: translate3d(0,0,0) scale(1.02); filter: blur(18px) saturate(1.25); }
  50%{ transform: translate3d(1.5vw,-1.2vh,0) scale(1.04); filter: blur(20px) saturate(1.35); }
  100%{ transform: translate3d(0,0,0) scale(1.02); filter: blur(18px) saturate(1.25); }
}
#ambientPoster{ animation: wtAmbientDrift 8.5s ease-in-out infinite; }
#ambientGlow{ animation: wtAmbientDrift 7.2s ease-in-out infinite reverse; }

/* ===== Page glass ===== */
    .glassPage{
      min-height: 100vh;
      padding: 160px 18px 90px;
      border-radius: 0;
      background: rgba(255,255,255,.032); border: 1px solid rgba(255,255,255,.085);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
    }

    .glassPage{
      position:relative;
      z-index:10;
    }
    .glassPage::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: 0;
      /* sandblasted grain */
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.06) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,.05) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,.04) 0 1px, transparent 2px);
      background-size: 18px 18px, 22px 22px, 26px 26px;
      mix-blend-mode: overlay;
      opacity: .35;
      filter: blur(.2px);
    }

    .glassPage::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
      background:
        radial-gradient(1200px 800px at 50% 10%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, rgba(0,0,0,0) 1px 3px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.014) 0 1px, rgba(0,0,0,0) 1px 4px);
      mix-blend-mode: overlay;
      opacity:.58;
    }
    /* keep actual content above grain */
    .glassPage > *{ position: relative; z-index: 2; }

/* Desktop často vypadá sklo „křídově bílé“ – stáhneme mléčný spodní rim a shine jen pro hover/pointer zařízení */
@media (hover: hover) and (pointer: fine){
  #wtModes{
    --glassClearA: rgba(255,255,255,.10);
    --glassClearB: rgba(255,255,255,.06);
    --glassMilkA:  rgba(255,255,255,.06);
    --glassMilkB:  rgba(255,255,255,.08);
    --botRim1: rgba(255,255,255,.46);
    --botRim2: rgba(255,255,255,.18);
  }
  #wtMainPill{
    --glassClearA: rgba(255,255,255,.10);
    --glassClearB: rgba(255,255,255,.06);
    --glassMilkA:  rgba(255,255,255,.06);
    --glassMilkB:  rgba(255,255,255,.08);
    --botRim1: rgba(255,255,255,.46);
    --botRim2: rgba(255,255,255,.18);
  }
  #wtModes .glassBase,
  #wtMainPill .glassBase{
    background:
      radial-gradient(120% 120% at 50% 60%, var(--glassMilkA), transparent 62%),
      radial-gradient(120% 120% at 50% 92%, var(--glassMilkB), transparent 58%),
      radial-gradient(120% 120% at 35% 25%, var(--glassClearA), transparent 55%),
      radial-gradient(140% 140% at 65% 70%, var(--glassClearB), transparent 60%),
      rgba(255,255,255,.05);
    box-shadow:
      inset 0 18px 26px rgba(0,0,0,.24),
      inset 0 -22px 30px rgba(255,255,255,.14),
      0 22px 44px rgba(0,0,0,.18);
  }
}

    .topBar{
      position: fixed;
      top: 0;
      z-index: 20;
      left: 0; right: 0;
      width: min(1180px, calc(100vw - 36px));
      margin: 0 auto;
      padding: calc(env(safe-area-inset-top) + 12px) 0 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
    }
    .rightGroup{ display:flex; gap:12px; align-items:center; margin-left:auto; }

    /* ===== mode buttons (round, like your WT arrows) ===== */
    #wtModes{
      --outer: 190px;
      --innerRatio: .65;
      --glassClearA: rgba(255,255,255,.14);
      --glassClearB: rgba(255,255,255,.08);
      --glassMilkA:  rgba(255,255,255,.10);
      --glassMilkB:  rgba(255,255,255,.12);
      --glassRingThickness: 13px;
      --glassRimBlur: 1.05px;
      --topRim1: rgba(0,0,0,.28);
      --topRim2: rgba(0,0,0,.12);
      --topRimFade: 30%;
      --botRim1: rgba(255,255,255,.74);
      --botRim2: rgba(255,255,255,.30);
      --bleedA: .14;
      --bleedB: .07;
      --pressY: 3px;
      --pressTimeIn: 110ms;
      --pressTimeOut: 190ms;

      --textColor: rgba(255,255,255,.92);
      --textSize: 34px;
      --textScaleX: 1.10;
      --textWidth: 92%;

      --stroke: rgba(0,0,0,.34);
      --depth1: rgba(0,0,0,.30);
      --depth2: rgba(0,0,0,.18);
      --lacquer: rgba(255,255,255,.28);

      --modeScale: .235;
      display:flex;
      gap: 12px;
      align-items:center;
    }

    #wtModes .wtModeBtn{ display:flex; align-items:center; }

    #wtModes .glassBase{
      --w: var(--outer);
      --h: var(--outer);
      --r: 50%;
      --smearInset: 10px;

      --rimTint: 120, 155, 255;
      --bleedX: 76%;
      --bleedY: 84%;

      width: var(--w);
      height: var(--h);
      border-radius: var(--r);
      position: relative;
      display:grid;
      place-items:center;
      isolation:isolate;

      background:
        radial-gradient(120% 120% at 50% 60%, var(--glassMilkA), transparent 62%),
        radial-gradient(120% 120% at 50% 92%, var(--glassMilkB), transparent 58%),
        radial-gradient(120% 120% at 35% 25%, var(--glassClearA), transparent 55%),
        radial-gradient(140% 140% at 65% 70%, var(--glassClearB), transparent 60%),
        rgba(255,255,255,.08);

      box-shadow:
        inset 0 18px 26px rgba(0,0,0,.24),
        inset 0 -22px 30px rgba(255,255,255,.22),
        0 22px 44px rgba(0,0,0,.18);

      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      transition: filter var(--pressTimeOut) ease;

      zoom: var(--modeScale);
      transform-origin: center;
    }
    @supports not (zoom: 1){
      #wtModes .glassBase{ zoom:1; transform: scale(var(--modeScale)); }
    }

    #wtModes .glassBase::before{
      content:"";
      position:absolute;
      inset: var(--smearInset);
      border-radius: var(--r);
      pointer-events:none;
      z-index:1;

      background:
        radial-gradient(75% 60% at 18% 22%,
          rgba(255,255,255,.42) 0%,
          rgba(255,255,255,.18) 35%,
          transparent 72%),
        radial-gradient(55% 45% at 28% 32%,
          rgba(255,255,255,.18) 0%,
          transparent 72%);

      filter: blur(1.35px);
      opacity:.90;
    }

    #wtModes .glassBase::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: var(--r);
      pointer-events:none;
      z-index:2;

      background:
        radial-gradient(72% 60% at var(--bleedX) var(--bleedY),
          rgba(var(--rimTint), var(--bleedA)) 0%,
          rgba(var(--rimTint), var(--bleedB)) 28%,
          transparent 68%),

        conic-gradient(from 210deg,
          transparent 0 18%,
          rgba(var(--rimTint), .12) 22%,
          transparent 36%,
          rgba(var(--rimTint), .06) 46%,
          transparent 62%,
          rgba(var(--rimTint), .045) 70%,
          transparent 100%),

        radial-gradient(140% 120% at 50% 120%,
          var(--botRim1) 0%,
          var(--botRim2) 22%,
          transparent 52%),

        radial-gradient(170% 120% at 50% -38%,
          var(--topRim1) 0%,
          var(--topRim2) 14%,
          transparent var(--topRimFade));

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      padding: var(--glassRingThickness);
      filter: blur(var(--glassRimBlur));
      opacity:.90;
    }

    #wtModes .pressGlow{
      position:absolute;
      inset:-22px;
      border-radius: 50%;
      pointer-events:none;
      opacity:0;
      filter: blur(10px);
      transition: opacity var(--pressTimeOut) ease, transform var(--pressTimeOut) ease;
      transform: scale(0.995);
      z-index:0;

      background:
        radial-gradient(80% 80% at 70% 70%,
          rgba(var(--rimTint), .18) 0%,
          rgba(var(--rimTint), .10) 26%,
          transparent 62%),
        radial-gradient(100% 90% at 50% 110%,
          rgba(255,255,255,.20) 0%,
          transparent 55%);
    }

    #wtModes .coreBtn{
      --cw: calc(var(--outer) * var(--innerRatio));
      --ch: calc(var(--outer) * var(--innerRatio));
      --cr: 50%;

      width: var(--cw);
      height: var(--ch);
      border-radius: var(--cr);

      position:relative;
      z-index:3;
      border:0;
      padding:0;
      cursor:pointer;

      outline: none !important;
      -webkit-tap-highlight-color: transparent;
      user-select:none;

      background:
        radial-gradient(120% 120% at 35% 25%, rgba(255,255,255,.16), transparent 55%),
        linear-gradient(180deg, #6f7ed0, #5462bb 55%, #4a57ae);

      box-shadow:
        0 18px 26px rgba(0,0,0,.18),
        inset 0 16px 22px rgba(0,0,0,.13),
        inset 0 -14px 20px rgba(255,255,255,.14);

      transform: translateY(0);
      transition:
        transform var(--pressTimeOut) cubic-bezier(.2,.8,.2,1),
        box-shadow var(--pressTimeOut) ease,
        filter var(--pressTimeOut) ease;

      display:grid;
      place-items:center;
    }

    #wtModes .glassBase:has(.coreBtn:active){ filter: brightness(.985); transition: filter var(--pressTimeIn) ease; }
    #wtModes .glassBase:has(.coreBtn:active) .pressGlow{ opacity:1; transform: scale(1.01); transition: opacity var(--pressTimeIn) ease, transform var(--pressTimeIn) ease; }
    #wtModes .coreBtn:active{
      transform: translateY(var(--pressY));
      transition:
        transform var(--pressTimeIn) cubic-bezier(.2,.8,.2,1),
        box-shadow var(--pressTimeIn) ease,
        filter var(--pressTimeIn) ease;

      box-shadow:
        0 10px 18px rgba(0,0,0,.16),
        inset 0 20px 26px rgba(0,0,0,.18),
        inset 0 -10px 16px rgba(255,255,255,.10);
      filter: brightness(.99) saturate(.98);
    }

    #wtModes .coreText{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;

      width: var(--textWidth);
      margin: 0 auto;

      color: var(--textColor);
      font-weight: 760;
      font-size: var(--textSize);
      letter-spacing: .40px;
      line-height: 1;
      text-transform: lowercase;

      transform: scaleX(var(--textScaleX));
      transform-origin: center;

      text-shadow:
        -0.75px 0      0 var(--stroke),
         0.75px 0      0 var(--stroke),
         0      -0.75px 0 var(--stroke),
         0       0.75px 0 var(--stroke),
        -0.55px -0.55px 0 var(--stroke),
         0.55px -0.55px 0 var(--stroke),
        -0.55px  0.55px 0 var(--stroke),
         0.55px  0.55px 0 var(--stroke),
        0 -0.55px 0 var(--lacquer),
        0  1.25px 1.45px var(--depth1),
        0  3px    8px    var(--depth2);
    }

    #wtModes .wtModeBtn.isActive .glassBase{ filter: saturate(1.05) brightness(1.03); }
    #wtModes .wtModeBtn.isActive .glassBase::after{ opacity: 1; }
    
    .titleMini{
      font-weight: 900;
      letter-spacing: .6px;
      color: rgba(255,255,255,.88);
      text-shadow: 0 14px 36px rgba(0,0,0,.55);
      user-select:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Grid plakátů ===== */
    #eventsGrid{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 26px;
      padding-top: 10px;
    }

    /* Date mode: single column posters */
    .poster{

      transition: transform 520ms cubic-bezier(.2,.8,.2,1);
      width: min(calc(100vw - 36px), 620px);
      margin: 0 auto;
/* removed GPU forcing to avoid partial render on some Android browsers */

      border-radius: 0 !important;
      overflow: visible !important;
      box-shadow: none !important;
      border: none !important;
      background: transparent !important;

}
    .poster img{

      width:100%;
      height:auto;
      display:block;
      border-radius: 0 !important;

    }
    /* No captions in Past Events */
    .cap{ display:none !important; }

    /* Random mode (koláž) – bez CSS columns (žádné „useknutí“ / fragmentace) */
    #eventsGrid.randomMode{
      display:grid;
      grid-auto-rows: 10px;
      grid-auto-flow: dense;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px;
      align-items:start;
      justify-items:center;
      overflow: visible;
    }
    #eventsGrid.randomMode .poster{

      width: 100%;
      max-width: 440px;
      margin: 0;
      position: relative; /* z-index funguje */
      transition: transform 520ms cubic-bezier(.2,.8,.2,1);
      transform:
        translate(var(--flipX,0px), var(--flipY,0px))
        translate(var(--tx,0px), var(--ty,0px))
        rotate(var(--rot,0deg))
        scale(var(--scl, 1));
      z-index: var(--z, 1);
      will-change: transform;
      border-radius: 0 !important;
      overflow: visible !important;
      box-shadow: none !important;
      border: none !important;
      background: transparent !important;

}

    /* Mobile: 2–3 vedle sebe (menší základ), pořád bez fragmentace */
    @media (max-width: 560px){
      #eventsGrid.randomMode{
        grid-template-columns: repeat(auto-fit, minmax(clamp(190px, 48vw, 320px), 1fr));
        gap: 16px 14px;
        padding: 0 12px;
      }
      #eventsGrid.randomMode .poster{
        max-width: none;
      }
    }
    @media (max-width: 420px){
      #eventsGrid.randomMode{
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px 10px;
        padding: 0 8px;
      }
    }
    @media (min-width: 720px){
      #eventsGrid.randomMode{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

.posterCard{
  /* neutralize legacy card styling */
  border-radius: 0 !important;
  overflow: visible !important;
  box-shadow: none !important;
  border: none !important;
  background: transparent !important;
  transform: none !important;
  text-decoration: none;
  color: inherit;
  display: block;
}
.posterCard img{ border-radius: 0 !important; width:100%; height:auto; display:block; }
.cap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding: 12px 12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.62));
      color:#fff;
    }
    .capTitle{ font-weight: 900; letter-spacing: .25px; text-transform: lowercase; }
    .capDate{ opacity:.88; font-size: 12px; }

    .err{
      max-width: 980px;
      margin: 18px auto 0;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
    }

    /* ===== WT pill (Main Page) — engine převzatý z oknoGIT.html ===== */
    #wtMainPill{

    --outer: 190px;
    --innerRatio: .65;
    --pillW: 440px;

    --glassClearA: rgba(255,255,255,.14);
    --glassClearB: rgba(255,255,255,.08);
    --glassMilkA:  rgba(255,255,255,.10);
    --glassMilkB:  rgba(255,255,255,.12);

    --glassRingThickness: 13px;
    --glassRimBlur: 1.05px;

    --topRim1: rgba(0,0,0,.28);
    --topRim2: rgba(0,0,0,.12);
    --topRimFade: 30%;

    --botRim1: rgba(255,255,255,.74);
    --botRim2: rgba(255,255,255,.30);

    --bleedA: .14;
    --bleedB: .07;

    --pressY: 3px;
    --pressTimeIn: 110ms;
    --pressTimeOut: 190ms;

    --textColor: rgba(255,255,255,.92);
    --textSize: 34px;
    --textScaleX: 1.12;
    --textWidth: 90%;

    --stroke: rgba(0,0,0,.34);
    --depth1: rgba(0,0,0,.30);
    --depth2: rgba(0,0,0,.18);
    --lacquer: rgba(255,255,255,.28);

    /* škálování do horního řádku okna */
    --pillScale: .253;
    display:flex;
    align-items:center;
  }

  #wtMainPill *{ box-sizing:border-box; }

  #wtMainPill .glassBase{
    --w: var(--outer);
    --h: var(--outer);
    --r: 50%;
    --smearInset: 10px;

    --rimTint: 120, 155, 255;
    --bleedX: 76%;
    --bleedY: 84%;

    width: var(--w);
    height: var(--h);
    border-radius: var(--r);
    position: relative;
    display:grid;
    place-items:center;
    isolation:isolate;

    background:
      radial-gradient(120% 120% at 50% 60%, var(--glassMilkA), transparent 62%),
      radial-gradient(120% 120% at 50% 92%, var(--glassMilkB), transparent 58%),
      radial-gradient(120% 120% at 35% 25%, var(--glassClearA), transparent 55%),
      radial-gradient(140% 140% at 65% 70%, var(--glassClearB), transparent 60%),
      rgba(255,255,255,.08);

    box-shadow:
      inset 0 18px 26px rgba(0,0,0,.24),
      inset 0 -22px 30px rgba(255,255,255,.22),
      0 22px 44px rgba(0,0,0,.18);

    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);

    transition: filter var(--pressTimeOut) ease;

    /* scale without distorting */
    zoom: var(--pillScale);
    transform-origin: left center;
  }
  @supports not (zoom: 1){
    #wtMainPill .glassBase{
      zoom: 1;
      transform: scale(var(--pillScale));
    }
  }

  #wtMainPill .glassBase::before{
    content:"";
    position:absolute;
    inset: var(--smearInset);
    border-radius: var(--r);
    pointer-events:none;
    z-index:1;

    background:
      radial-gradient(75% 60% at 18% 22%,
        rgba(255,255,255,.42) 0%,
        rgba(255,255,255,.18) 35%,
        transparent 72%),
      radial-gradient(55% 45% at 28% 32%,
        rgba(255,255,255,.18) 0%,
        transparent 72%);

    filter: blur(1.35px);
    opacity:.90;
  }

  #wtMainPill .glassBase::after{
    content:"";
    position:absolute;
    inset:-1px;
    border-radius: var(--r);
    pointer-events:none;
    z-index:2;

    background:
      radial-gradient(72% 60% at var(--bleedX) var(--bleedY),
        rgba(var(--rimTint), var(--bleedA)) 0%,
        rgba(var(--rimTint), var(--bleedB)) 28%,
        transparent 68%),

      conic-gradient(from 210deg,
        transparent 0 18%,
        rgba(var(--rimTint), .12) 22%,
        transparent 36%,
        rgba(var(--rimTint), .06) 46%,
        transparent 62%,
        rgba(var(--rimTint), .045) 70%,
        transparent 100%),

      radial-gradient(140% 120% at 50% 120%,
        var(--botRim1) 0%,
        var(--botRim2) 22%,
        transparent 52%),

      radial-gradient(170% 120% at 50% -38%,
        var(--topRim1) 0%,
        var(--topRim2) 14%,
        transparent var(--topRimFade));

    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;

    padding: var(--glassRingThickness);
    filter: blur(var(--glassRimBlur));
    opacity:.90;
  }

  #wtMainPill .pressGlow{
    position:absolute;
    inset:-22px;
    border-radius: var(--r);
    pointer-events:none;
    opacity:0;
    filter: blur(10px);
    transition: opacity var(--pressTimeOut) ease, transform var(--pressTimeOut) ease;
    transform: scale(0.995);
    z-index:0;

    background:
      radial-gradient(80% 80% at 70% 70%,
        rgba(var(--rimTint), .18) 0%,
        rgba(var(--rimTint), .10) 26%,
        transparent 62%),
      radial-gradient(100% 90% at 50% 110%,
        rgba(255,255,255,.20) 0%,
        transparent 55%);
  }

  #wtMainPill .coreBtn{
    --cw: calc(var(--outer) * var(--innerRatio));
    --ch: calc(var(--outer) * var(--innerRatio));
    --cr: 50%;

    width: var(--cw);
    height: var(--ch);
    border-radius: var(--cr);

    position:relative;
    z-index:3;
    border:0;
    padding:0;
    cursor:pointer;

    outline: none !important;
    -webkit-tap-highlight-color: transparent;
    user-select:none;

    background:
      radial-gradient(120% 120% at 35% 25%, rgba(255,255,255,.16), transparent 55%),
      linear-gradient(180deg, var(--c1), var(--c2) 55%, var(--c3));

    box-shadow:
      0 18px 26px rgba(0,0,0,.18),
      inset 0 16px 22px rgba(0,0,0,.13),
      inset 0 -14px 20px rgba(255,255,255,.14);

    transform: translateY(0);
    transition:
      transform var(--pressTimeOut) cubic-bezier(.2,.8,.2,1),
      box-shadow var(--pressTimeOut) ease,
      filter var(--pressTimeOut) ease;

    display:grid;
    place-items:center;

    /* make it a link that looks like a button */
    text-decoration:none;
  }

  #wtMainPill .glassBase:has(.coreBtn:active){
    filter: brightness(.985);
    transition: filter var(--pressTimeIn) ease;
  }
  #wtMainPill .glassBase:has(.coreBtn:active) .pressGlow{
    opacity:1;
    transform: scale(1.01);
    transition: opacity var(--pressTimeIn) ease, transform var(--pressTimeIn) ease;
  }
  #wtMainPill .coreBtn:active{
    transform: translateY(var(--pressY));
    transition:
      transform var(--pressTimeIn) cubic-bezier(.2,.8,.2,1),
      box-shadow var(--pressTimeIn) ease,
      filter var(--pressTimeIn) ease;

    box-shadow:
      0 10px 18px rgba(0,0,0,.16),
      inset 0 20px 26px rgba(0,0,0,.18),
      inset 0 -10px 16px rgba(255,255,255,.10);
    filter: brightness(.99) saturate(.98);
  }

  #wtMainPill .pill{
    --w: var(--pillW);
    --h: var(--outer);
    --r: calc(var(--outer)/2);
    --gap: calc(var(--outer) * (1 - var(--innerRatio)) / 2);
  }
  #wtMainPill .pill .coreBtn{
    --ch: calc(var(--outer) * var(--innerRatio));
    --cw: calc(var(--pillW) - (2 * var(--gap)));
    --cr: calc((var(--outer) * var(--innerRatio)) / 2);
  }

  #wtMainPill .v-blue{
    --c1:#6f7ed0; --c2:#5462bb; --c3:#4a57ae;
    --rimTint: 120, 155, 255;
    --bleedX: 74%; --bleedY: 86%;
  }

  #wtMainPill .coreText{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;

    width: var(--textWidth);
    margin: 0 auto;

    color: var(--textColor);
    font-weight: 720;
    font-size: var(--textSize);
    letter-spacing: .55px;
    line-height: 1;
    text-transform: lowercase;

    transform: scaleX(var(--textScaleX));
    transform-origin: center;

    text-shadow:
      -0.75px 0      0 var(--stroke),
       0.75px 0      0 var(--stroke),
       0      -0.75px 0 var(--stroke),
       0       0.75px 0 var(--stroke),
      -0.55px -0.55px 0 var(--stroke),
       0.55px -0.55px 0 var(--stroke),
      -0.55px  0.55px 0 var(--stroke),
       0.55px  0.55px 0 var(--stroke),
      0 -0.55px 0 var(--lacquer),
      0  1.25px 1.45px var(--depth1),
      0  3px    8px    var(--depth2);
  }
#wtModes .coreBtn{
      display:grid;
      place-items:center;
    }


    .wtIcon{
      width: 30px;
      height: 30px;
      display:block;
      color: rgba(18,18,22,.92);
    }


/* ===== Random (puzzle) na telefonu: 2–3 vedle sebe + víc překryvů ===== */


/* ===== Více viditelný ambient pod pískovaným sklem ===== */
#ambientPoster{ opacity:.88; mix-blend-mode: screen; }
#ambientGlow{ opacity: 1; }
.glassPage{ background: rgba(255,255,255,.026); }

  
/* ===== HERO (odloupnutí plakátu) ===== */
body.heroOpen #eventsGrid{ filter:none; opacity:1; transform:none; transition: none; }
body.heroOpen .topBar{ opacity:1; filter:none; }
#heroOverlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 0;
}
#heroOverlay.isOpen{ display:flex; }
#heroOverlay .heroBack{ position:absolute; inset:0; background: rgba(0,0,0,.22); }
#heroOverlay .heroCard{ position: fixed; inset:0; width:100vw; height:100vh; border-radius:0; overflow:hidden; box-shadow:none; border:none; background: transparent; transform: translateZ(0); will-change: left, top, width, height, border-radius; }
#heroOverlay .heroCard img{ width: 100%; height: 100%; object-fit: contain; display:block; background: transparent; }


/* ===== HERO roll (srolování / odrolování) ===== */
#heroOverlay .rollWrap{
  position:absolute;
  inset:0;
  transform-origin: top;
  transform: scaleY(0.02);
  will-change: transform, filter;
}
#heroOverlay .rollWrap img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display:block;
  background: transparent;

  border-radius: 0;
}
#heroOverlay .roller{
  position:absolute;
  left: 50%;
  top: -10px;
  transform: translateX(-50%);
  width: 86%;
  max-width: 720px;
  height: 26px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.18));
  box-shadow:
    0 10px 26px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.22),
    inset 0 -10px 18px rgba(0,0,0,.28);
  opacity: 0;
  pointer-events:none;

  display:block;
}

@keyframes unrollPoster{
  0%   { transform: scaleY(0.02); filter: blur(1.6px); }
  55%  { transform: scaleY(1.02); filter: blur(.2px); }
  100% { transform: scaleY(1); filter: blur(0); }
}
@keyframes rollUpPoster{
  0%   { transform: scaleY(1); filter: blur(0); }
  100% { transform: scaleY(0.02); filter: blur(1.6px); }
}
@keyframes rollerPop{
  0%   { opacity: 0; transform: translateX(-50%) translateY(-10px); }
  18%  { opacity: .92; transform: translateX(-50%) translateY(0); }
  70%  { opacity: .55; transform: translateX(-50%) translateY(16px); }
  100% { opacity: 0; transform: translateX(-50%) translateY(26px); }
}

#heroOverlay .heroCard.unrolling .rollWrap{
  animation: unrollPoster 520ms cubic-bezier(.16,.9,.18,1) both;
}
#heroOverlay .heroCard.unrolling .roller{
  animation: rollerPop 520ms cubic-bezier(.16,.9,.18,1) both;
}
#heroOverlay .heroCard.rollingUp .rollWrap{
  animation: rollUpPoster 260ms cubic-bezier(.2,.8,.2,1) both;
}
#heroOverlay .heroCard.rollingUp .roller{
  opacity: .9;
  animation: rollerPop 260ms cubic-bezier(.2,.8,.2,1) both;
}
/* ===== Stabilizace kompozice (zoom / mobile blikání) ===== */
#ambientBg, #ambientPoster, #ambientGlow{ will-change: transform, opacity, filter; transform: translateZ(0); }
.glassPage{ isolation:isolate; }


    /* labels inside round mode buttons (replace icons) */
    #wtModes .modeLabel{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;

      width: var(--textWidth);
      margin: 0 auto;

      /* requested: black text, same font feel as Main Page */
      color: rgba(0,0,0,.92);
      font-weight: 760;
      font-size: calc(var(--textSize) * 1.08);
      letter-spacing: .40px;
      line-height: 1;
      text-transform: lowercase;

      transform: scaleX(var(--textScaleX));
      transform-origin: center;

      /* remove outline/shadow so it stays clean black */
      text-shadow: none;
    }


/* HERO fullscreen poster (no background layer) */
#heroOverlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  background: transparent;
  backdrop-filter: none;
}
#heroOverlay.open{ display:block; }

#heroImg{
  position:absolute;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  object-fit:contain;
  cursor:pointer;
  background:transparent;
}

</style>
</head>
<body>
  <div id="pageBase" aria-hidden="true"></div>
  <div id="ambientBg"></div>
  <div id="ambientPoster"></div>
  <div id="ambientGlow"></div>

  <div class="topBar">
      <div id="wtMainPill" aria-label="Main page">
        <div class="glassBase pill v-blue">
          <div class="pressGlow"></div>
          <a class="coreBtn" href="index.html" aria-label="Main page">
            <span class="coreText">main page</span>
          </a>
        </div>
      </div>

      <div class="rightGroup">
        <div id="wtModes" class="modes" aria-label="Řazení plakátů">
          <div class="wtModeBtn isActive" data-mode="date" aria-label="Řazení podle data">
            <div class="glassBase v-blue">
              <div class="pressGlow"></div>
              <button class="coreBtn" type="button" aria-label="Řadit podle data">
                <span class="modeLabel">date</span>
              </button>
            </div>
          </div>

          <div class="wtModeBtn" data-mode="random" aria-label="Náhodné rozložení">
            <div class="glassBase v-blue">
              <div class="pressGlow"></div>
              <button class="coreBtn" type="button" aria-label="Náhodné rozložení">
                <span class="modeLabel">rndm</span>
              </button>
            </div>
          </div>
        </div>
</div>
    </div>

    
  <div class="glassPage">
    <div id="eventsGrid" aria-label="Seznam plakátů"></div>
  </div>

  <!-- HERO overlay -->
  <div id="heroOverlay" aria-hidden="true">
    <div class="heroBack" data-hero-close="1"></div>
    <div class="heroCard" role="dialog" aria-modal="true"></div>
</div>

<script>
  const DATA_URL = 'data/events.json';

  const grid = document.getElementById('eventsGrid');
  const ambient = document.getElementById('ambientBg');
  const ambientGlow = document.getElementById('ambientGlow');
  const ambientPoster = document.getElementById('ambientPoster');

  const modeButtons = Array.from(document.querySelectorAll('#wtModes .wtModeBtn'));

  // --- helpers
  const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
  function parseDate(s){
    const [y,m,d] = String(s||'').split('-').map(Number);
    return new Date(y||1970, (m||1)-1, d||1, 12, 0, 0);
  }

  // --- ambient: use averaged color (smoothly), poster image only as very subtle texture
  let ambCurrent = { r:145, g:85, b:255 };
  let ambTarget  = { r:145, g:85, b:255 };
  let ambRAF = 0;

  function applyAmbient(){
    const r = Math.round(ambCurrent.r);
    const g = Math.round(ambCurrent.g);
    const b = Math.round(ambCurrent.b);

    // CSS-var based purple base + poster-derived color.
    ambient.style.setProperty('--ambR', r);
    ambient.style.setProperty('--ambG', g);
    ambient.style.setProperty('--ambB', b);

    ambientGlow.style.background =
      `radial-gradient(circle at 50% 42%, rgba(${r},${g},${b},.38), transparent 58%)`;
  }

  function tickAmbient(){
    // critically damped-ish easing to avoid "skákání"
    ambCurrent.r += (ambTarget.r - ambCurrent.r) * 0.10;
    ambCurrent.g += (ambTarget.g - ambCurrent.g) * 0.10;
    ambCurrent.b += (ambTarget.b - ambCurrent.b) * 0.10;

    applyAmbient();
    window.addEventListener('resize', scheduleMasonry, { passive:true });
    window.addEventListener('orientationchange', scheduleMasonry, { passive:true });

    const dr = Math.abs(ambTarget.r - ambCurrent.r);
    const dg = Math.abs(ambTarget.g - ambCurrent.g);
    const db = Math.abs(ambTarget.b - ambCurrent.b);
    if (dr + dg + db > 0.8){
      ambRAF = requestAnimationFrame(tickAmbient);
    } else {
      ambRAF = 0;
    }
  }

  function setAmbientTarget(rgb){
    ambTarget = {
      r: clamp(rgb.r, 0, 255),
      g: clamp(rgb.g, 0, 255),
      b: clamp(rgb.b, 0, 255),
    };
    if(!ambRAF) ambRAF = requestAnimationFrame(tickAmbient);
  }

  async function getAverageColor(img){
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d', { willReadFrequently:true });
    const w = 42, h = 42;
    c.width = w; c.height = h;

    ctx.drawImage(img, 0, 0, w, h);
    const data = ctx.getImageData(0,0,w,h).data;

    let r=0,g=0,b=0,count=0;
    for(let i=0;i<data.length;i+=4){
      const a = data[i+3];
      if(a < 24) continue;
      r += data[i];
      g += data[i+1];
      b += data[i+2];
      count++;
    }
    if(!count) return {r:145,g:85,b:255};
    return { r: r/count, g: g/count, b: b/count };
  }

  // very subtle poster texture (optional, not "viditelný plakát")
  function setPosterTexture(img){
    const src = img.currentSrc || img.src;
    ambientPoster.style.backgroundImage = `url('${src}')`;
  }

  // --- render
  let items = [];
  let currentMode = 'date';
  let observer = null;

  function posterEl(e, idx){
    const a = document.createElement(e.link ? 'a' : 'div');
    a.className = 'poster';
    // fullscreen toggle v random režimu (spolehlivější než delegace na některých mobilech)
    a.addEventListener('pointerup', (ev) => {
      if(!grid.classList.contains('randomMode')) return;
      if(ev.cancelable) ev.preventDefault();
      ev.stopPropagation();
      const img = a.querySelector('img');
      const src = img ? (img.currentSrc || img.src) : null;
      if(heroOpen && src && src === heroSrc){ closeHero(); return; }
      openHero(a);
    }, { passive:false });

    a.addEventListener('click', (ev) => {
      if(!grid.classList.contains('randomMode')) return; // v date módu nech odkazy fungovat
      if(ev.cancelable) ev.preventDefault();
      ev.stopPropagation();
      const img = a.querySelector('img');
      const src = img ? (img.currentSrc || img.src) : null;
      if(heroOpen && src && src === heroSrc){ closeHero(); return; }
      openHero(a);
    }, { passive:false });

    a.dataset.key = String(idx);
    if(e.link) {
      a.href = e.link;
      a.target = '_blank';
      a.rel = 'noopener';
      // (no posterCard styling)
      // a.classList.add('posterCard');
    }

    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = e.title || '';
    img.src = e.image;
    img.addEventListener('load', () => { if(grid.classList.contains('randomMode')) applyMasonry(); }, { once:false });

    a.appendChild(img);
    return a;
  }

  function updateActiveMode(mode){
    modeButtons.forEach(btn => {
      const is = btn.dataset.mode === mode;
      btn.classList.toggle('isActive', is);
    });
  }

  function shufflePosters(){
    const posters = Array.from(grid.querySelectorAll('.poster'));
    for(let i = posters.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = posters[i];
      posters[i] = posters[j];
      posters[j] = tmp;
    }
    posters.forEach(p => grid.appendChild(p));
  }


  // ===== Masonry (vyplnění mezer v random gridu) =====
  let masonryRAF = 0;
  function applyMasonry(){
    if(!grid.classList.contains('randomMode')) return;
    if(masonryRAF) cancelAnimationFrame(masonryRAF);
    masonryRAF = requestAnimationFrame(() => {
      masonryRAF = 0;
      const cs = getComputedStyle(grid);
      const rowH = parseFloat(cs.getPropertyValue('grid-auto-rows')) || 10;
      const rowGap = parseFloat(cs.rowGap) || 0;
      const posters = Array.from(grid.querySelectorAll('.poster'));
      posters.forEach(p => {
        const img = p.querySelector('img');
        if(!img) return;
        const h = img.getBoundingClientRect().height;
        if(!h || !isFinite(h)) return;
        const span = Math.max(1, Math.ceil((h + rowGap) / (rowH + rowGap)));
        p.style.gridRowEnd = `span ${span}`;
      });
    });
  }

  let masonryResizeTimer = 0;
  function scheduleMasonry(){
    if(masonryResizeTimer) clearTimeout(masonryResizeTimer);
    masonryResizeTimer = setTimeout(() => applyMasonry(), 80);
  }


  function clearRandomVars(){
    const posters = Array.from(grid.querySelectorAll('.poster'));
    posters.forEach(el => {
      el.style.removeProperty('--tx');
      el.style.removeProperty('--ty');
      el.style.removeProperty('--rot');
      el.style.removeProperty('--scl');
      el.style.removeProperty('--lift');
      el.style.removeProperty('--z');
    });
  }

  function flipAnimate(before){
    const posters = Array.from(grid.querySelectorAll('.poster'));
    posters.forEach(el => {
      const key = el.dataset.key;
      const b = before.get(key);
      if(!b) return;
      const a = el.getBoundingClientRect();
      const dx = b.left - a.left;
      const dy = b.top - a.top;
      if(Math.abs(dx)+Math.abs(dy) < 0.5) return;

      el.style.setProperty('--flipX', dx.toFixed(1)+'px');
      el.style.setProperty('--flipY', dy.toFixed(1)+'px');
      el.style.willChange = 'transform';

      // next frame -> animate to 0
      requestAnimationFrame(() => {
        el.style.setProperty('--flipX', '0px');
        el.style.setProperty('--flipY', '0px');
        // cleanup will-change after transition
        setTimeout(() => { el.style.willChange = ''; }, 650);
      });
    });
  }

  function setMode(mode){
  const posters = Array.from(grid.querySelectorAll('.poster'));
  const before = new Map();
  posters.forEach(el => before.set(el.dataset.key, el.getBoundingClientRect()));

  // allow "Random" to reshuffle + re-randomize on repeated clicks
  if(mode === currentMode){
    if(mode === 'random'){
      shufflePosters();
      randomizeVars();
      applyMasonry();
      requestAnimationFrame(() => flipAnimate(before));
    }
    return;
  }

  currentMode = mode;
  grid.classList.toggle('randomMode', mode === 'random');
  updateActiveMode(mode);

  setPosterLinksEnabled(mode !== 'random');

  if(mode === 'random'){
    shufflePosters();
    randomizeVars();
    applyMasonry();
  }else{
    clearRandomVars();
    // reset masonry spans
    Array.from(grid.querySelectorAll('.poster')).forEach(p=>{ p.style.gridRowEnd=''; });
  }

  requestAnimationFrame(() => flipAnimate(before));
}

  function setPosterLinksEnabled(enabled){
    // enabled=true: plakáty jsou normální odkazy (date mód)
    // enabled=false: v random módu odstraníme href, aby prohlížeč nikdy neskákal na # ani neotevíral link
    const posters = Array.from(grid.querySelectorAll('.poster'));
    posters.forEach(p => {
      if(p.tagName !== 'A') return;
      if(enabled){
        if(p.dataset.realHref){
          p.setAttribute('href', p.dataset.realHref);
          delete p.dataset.realHref;
        }
      }else{
        // ulož původní href a pak ho smaž
        const h = p.getAttribute('href');
        if(h){
          p.dataset.realHref = h;
        }
        p.removeAttribute('href');
      }
    });
  }

  // ===== HERO (odloupnutí plakátu) =====
  const heroOverlay = document.getElementById('heroOverlay');
  const heroCard = heroOverlay ? heroOverlay.querySelector('.heroCard') : null;

  let heroOpen = false;
  let heroFrom = null; // {left,top,width,height,borderRadius}
  let heroSrc = null;
  let heroJustOpenedAt = 0;

  function getPosterFromTarget(t){
    const el = t.closest && t.closest('.poster');
    return el || null;
  }

  function openHero(posterEl){
    if(!heroOverlay || !heroCard) return;
    const img = posterEl.querySelector('img');
    if(!img) return;

    const rect = img.getBoundingClientRect();
    heroFrom = { left: rect.left, top: rect.top, width: rect.width, height: rect.height, r: 18 };
    heroSrc = img.currentSrc || img.src;

    // lock scroll
    document.body.classList.add('heroOpen');
    heroOverlay.classList.add('isOpen');
    heroOverlay.setAttribute('aria-hidden', 'false');
    heroOpen = true;
    // Mobile "ghost click" guard: overlay se může objevit pod prstem a hned dostat klik -> okamžité zavření.
    heroJustOpenedAt = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();

    // Build hero card content (roll/unroll)
    heroCard.innerHTML = '';
    heroCard.classList.remove('unrolling','rollingUp');
    const wrap = document.createElement('div');
    wrap.className = 'rollWrap';
    const hi = document.createElement('img');
    hi.alt = img.alt || '';
    hi.src = heroSrc;
    const roller = document.createElement('div');
    roller.className = 'roller';
    wrap.appendChild(hi);
    wrap.appendChild(roller);
    heroCard.appendChild(wrap);

    // Start at original rect
    heroCard.style.left = heroFrom.left + 'px';
    heroCard.style.top = heroFrom.top + 'px';
    heroCard.style.width = heroFrom.width + 'px';
    heroCard.style.height = heroFrom.height + 'px';
    heroCard.style.borderRadius = '0px';

    // Target size
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const maxW = Math.min(vw - 32, 980);
    const maxH = Math.min(vh - 96, 900);
    const natW = img.naturalWidth || rect.width;
    const natH = img.naturalHeight || rect.height;
    const scale = Math.min(maxW / natW, maxH / natH, 1.0);
    const tW = Math.max(240, Math.round(natW * scale));
    const tH = Math.max(240, Math.round(natH * scale));
    const tL = Math.round((vw - tW) / 2);
    const tT = Math.round((vh - tH) / 2);

    // Animate to center
    heroCard.style.transition = 'none';
    requestAnimationFrame(() => {
      heroCard.style.transition = 'left 360ms cubic-bezier(.2,.85,.2,1), top 360ms cubic-bezier(.2,.85,.2,1), width 360ms cubic-bezier(.2,.85,.2,1), height 360ms cubic-bezier(.2,.85,.2,1), border-radius 360ms ease';
      heroCard.style.left = tL + 'px';
      heroCard.style.top = tT + 'px';
      heroCard.style.width = tW + 'px';
      heroCard.style.height = tH + 'px';
      heroCard.style.borderRadius = '0px';
      // start "odrolování" efekt
      heroCard.classList.remove('rollingUp');
      heroCard.classList.add('unrolling');
    });

    // Optional: shift ambient to selected poster (jemně)
    if(img.complete){
      setPosterTexture(img);
      getAverageColor(img).then(setAmbientTarget).catch(()=>{});
    }
  }

  function closeHero(){
    if(!heroOverlay || !heroCard || !heroOpen || !heroFrom) return;

    // start roll-up immediately
    heroCard.classList.remove('unrolling');
    heroCard.classList.add('rollingUp');

    heroCard.style.transition = 'left 260ms cubic-bezier(.2,.8,.2,1), top 260ms cubic-bezier(.2,.8,.2,1), width 260ms cubic-bezier(.2,.8,.2,1), height 260ms cubic-bezier(.2,.8,.2,1), border-radius 260ms ease';
    heroCard.style.left = heroFrom.left + 'px';
    heroCard.style.top = heroFrom.top + 'px';
    heroCard.style.width = heroFrom.width + 'px';
    heroCard.style.height = heroFrom.height + 'px';
    heroCard.style.borderRadius = '0px';

    window.setTimeout(() => {
      heroOverlay.classList.remove('isOpen');
      heroOverlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('heroOpen');
      heroCard.classList.remove('unrolling','rollingUp');
      heroCard.innerHTML = '';
      heroOpen = false;
      heroFrom = null;
      heroSrc = null;
      heroJustOpenedAt = 0;
    }, 280);
  }

  if(heroOverlay){
    heroOverlay.addEventListener('click', (e) => {
      // ignoruj první klik hned po otevření (touch -> click na mobilu)
      const now = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
      if(heroJustOpenedAt && (now - heroJustOpenedAt) < 380) return;
      // zavírej klikem na backdrop i na samotný plakát (rychlé toggle)
      const t = e.target;
      const isBackdrop = t && (t.getAttribute && t.getAttribute('data-hero-close') === '1');
      const isCard = t && (t.closest && t.closest('.heroCard'));
      if(isBackdrop || isCard) closeHero();
    });
    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') closeHero();
    });
  }


  function setupAmbientObserver(){
    if(observer) observer.disconnect();

    const imgs = Array.from(grid.querySelectorAll('img'));
    if(!imgs.length) return;

    // initial
    imgs[0].addEventListener('load', async () => {
      setPosterTexture(imgs[0]);
      setAmbientTarget(await getAverageColor(imgs[0]));
    }, { once:true });

    // track the image closest to center via intersection ratio
    observer = new IntersectionObserver(async (entries) => {
      const best = entries
        .filter(e => e.isIntersecting)
        .sort((a,b)=> b.intersectionRatio - a.intersectionRatio)[0];
      if(!best) return;

      const img = best.target;
      if(!img.complete) return;

      // subtle texture + smooth color
      setPosterTexture(img);
      const rgb = await getAverageColor(img);
      setAmbientTarget(rgb);
    }, { threshold: [0.35, 0.55, 0.72] });

    imgs.forEach(img => {
      if(img.complete) observer.observe(img);
      else img.addEventListener('load', () => observer.observe(img), { once:true });
    });
  }

  async function init(){
    // fetch json
    const res = await fetch(DATA_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('Nejde načíst '+DATA_URL+' (status '+res.status+')');
    const all = await res.json();

    const today = new Date(); today.setHours(0,0,0,0);
    items = (all||[])
      .filter(e => e && e.date && e.image && parseDate(e.date) < today)
      .sort((a,b)=> parseDate(b.date) - parseDate(a.date));

    if(!items.length){
      grid.innerHTML = '<div class="err">V JSONu nejsou žádné minulé akce.</div>';
      return;
    }

    // render once (stable DOM so FLIP works)
    grid.innerHTML = '';
    items.forEach((e, idx) => grid.appendChild(posterEl(e, idx)));

    // HERO click: jen v režimu random (toggle open/close na stejný plakát)
    // --- poster fullscreen (jen v random režimu) ---
    let lastHeroPointerUpAt = 0;

    function handlePosterActivate(ev){
      const p = getPosterFromTarget(ev.target);
      if(!p) return;

      // jen v random režimu
      if(!grid.classList.contains('randomMode')) return;

      // v random režimu neodcházej pryč – otevři/zaklapni fullscreen
      if(ev.cancelable) ev.preventDefault();
      ev.stopPropagation();

      const img = p.querySelector('img');
      const src = img ? (img.currentSrc || img.src) : null;

      if(heroOpen){
        // klik na stejný plakát -> zavřít, klik na jiný -> přepnout na nový
        if(src && src === heroSrc){
          closeHero();
          return;
        }
      }
      openHero(p);
    }

    // Na mobilech je spolehlivější pointerup než click (a zabrání to i hash-jumpu na #)
    grid.addEventListener('pointerup', (ev) => {
      lastHeroPointerUpAt = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
      handlePosterActivate(ev);
    }, { passive:false });

    // Click musí v random režimu vždy zastavit navigaci (u <a> je default až na click, ne na pointerup).
    // Proto i když click ignorujeme kvůli guardu (pointerup -> click), pořád uděláme preventDefault().
    grid.addEventListener('click', (ev) => {
      const now = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();

      // když jsme v random režimu a klik je na plakát, vždy stopni default (jinak to skáče na # / otevírá link)
      if(grid.classList.contains('randomMode')){
        const p = getPosterFromTarget(ev.target);
        if(p){
          if(ev.cancelable) ev.preventDefault();
          ev.stopPropagation();
        }
      }

      // guard proti dvojitému vyvolání (pointerup -> click)
      if(now - lastHeroPointerUpAt < 450) return;

      handlePosterActivate(ev);
    }, { passive:false });

    // hook buttons
    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => setMode(btn.dataset.mode));
      const b = btn.querySelector('button');
      if(b) b.addEventListener('click', () => setMode(btn.dataset.mode));
    });

    // default mode = date
    updateActiveMode('date');
    clearRandomVars();
    // reset masonry spans
    Array.from(grid.querySelectorAll('.poster')).forEach(p=>{ p.style.gridRowEnd=''; });
    setPosterLinksEnabled(true);

    setupAmbientObserver();
    applyAmbient();
    window.addEventListener('resize', scheduleMasonry, { passive:true });
    window.addEventListener('orientationchange', scheduleMasonry, { passive:true });
  }

  init().catch(err => {
    grid.innerHTML = '<div class="err">'+String(err.message || err)+'</div>';
  });
</script>
</body>
</html>
