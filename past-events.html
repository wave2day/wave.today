<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Past Events</title>

  <style>
    :root{
      --pad: 14px;
      --glassA: rgba(255,255,255,.055);
      --glassB: rgba(255,255,255,.035);
      --rim: rgba(255,255,255,.16);
      --txt: rgba(240,245,255,.92);
    }

    html,body{
      margin:0; padding:0;
      background:#0b0b10;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x:hidden;
    }

    a,button{ -webkit-tap-highlight-color: transparent; }
    a:focus, a:focus-visible, button:focus, button:focus-visible{ outline:none; box-shadow:none; }

    /* ambient background */
    #ambientBg{
      position:fixed; inset:0; z-index:-2;
      background: radial-gradient(circle at 50% 35%, rgba(120,150,255,.28), transparent 62%);
      transition: background .55s ease;
    }

    /* glass sheet */
    #sheet{
      min-height:100vh;
      padding: calc(env(safe-area-inset-top) + var(--pad)) var(--pad)
               calc(env(safe-area-inset-bottom) + 90px) var(--pad);
      background: linear-gradient(180deg, var(--glassA), var(--glassB));
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
    }

    /* top bar */
    #top{
      position: sticky;
      top: 0;
      z-index: 5;
      padding: 6px 0 14px 0;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background: linear-gradient(180deg, rgba(11,11,16,.65), rgba(11,11,16,0));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* main page pill */
    #backPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:rgba(245,248,255,.95);
      font-weight:900;
      letter-spacing:.2px;
      padding: 12px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        0 18px 40px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.12);
    }
    #backPill:active{ transform: translateY(1px); }

    /* posters grid */
    #grid{
      max-width: 1100px;
      margin: 10px auto 0 auto;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
      gap: 26px;
    }

    .poster{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 24px 60px rgba(0,0,0,.48);
      border: 1px solid rgba(255,255,255,.08);
      transform: translateZ(0);
    }
    .poster img{
      width:100%;
      height:auto;
      display:block;
    }

    /* subtle bottom caption (no extra text unless you want it) */
    .cap{
      position:absolute; left:0; right:0; bottom:0;
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.60));
      color: rgba(245,248,255,.92);
      font-size: 12px;
      letter-spacing:.2px;
    }
    .cap .t{ font-weight:900; }
    .cap .d{ opacity:.85; }

    /* small error box if something fails */
    #err{
      display:none;
      position:fixed;
      left:10px; right:10px; top:10px;
      z-index:9999;
      background: rgba(0,0,0,.75);
      border: 1px solid rgba(255,255,255,.18);
      color:#fff;
      padding:10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div id="ambientBg" aria-hidden="true"></div>
  <div id="err"></div>

  <main id="sheet" aria-label="Past events">
    <div id="top">
      <a id="backPill" href="index.html" aria-label="Main page">main page</a>
    </div>

    <div id="grid" aria-label="Posters"></div>
  </main>

  <script>
    const DATA_URL = 'data/events.json'; // u tebe je data/ v rootu
    const grid = document.getElementById('grid');
    const ambient = document.getElementById('ambientBg');
    const errBox = document.getElementById('err');

    const colorCache = new Map();

    function showErr(msg){
      errBox.style.display = 'block';
      errBox.textContent = msg;
    }

    function parseDate(s){
      const [y,m,d] = s.split('-').map(Number);
      return new Date(y, (m||1)-1, d||1, 12, 0, 0);
    }

    function setAmbientRGBA(r,g,b,a){
      ambient.style.background =
        `radial-gradient(circle at 50% 35%, rgba(${r},${g},${b},${a}), transparent 62%)`;
    }

    async function avgColorFromImage(img){
      const key = img.currentSrc || img.src;
      if (colorCache.has(key)) return colorCache.get(key);

      const c = document.createElement('canvas');
      const ctx = c.getContext('2d', { willReadFrequently: true });

      // downscale for speed
      const w = 48, h = 48;
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);

      const data = ctx.getImageData(0,0,w,h).data;
      let r=0,g=0,b=0,count=0;

      for(let i=0;i<data.length;i+=4){
        const a = data[i+3];
        if (a < 20) continue; // skip transparent
        r += data[i];
        g += data[i+1];
        b += data[i+2];
        count++;
      }
      if(!count) { r=120; g=150; b=255; count=1; }

      r = Math.round(r/count);
      g = Math.round(g/count);
      b = Math.round(b/count);

      const res = {r,g,b};
      colorCache.set(key, res);
      return res;
    }

    async function load(){
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if(!res.ok) throw new Error('Nejde načíst ' + DATA_URL + ' (status ' + res.status + ')');
      const all = await res.json();

      const today = new Date();
      today.setHours(0,0,0,0);

      const past = all
        .filter(e => e && e.date && parseDate(e.date) < today)
        .sort((a,b) => parseDate(b.date) - parseDate(a.date));

      if(!past.length){
        showErr('V JSONu nejsou žádné minulé akce (date < dnes).');
        return;
      }

      grid.innerHTML = past.map(e => `
        <div class="poster">
          <img loading="lazy" src="${e.image}" alt="${e.title || ''}">
          <div class="cap">
            <span class="t">${e.title || ''}</span>
            <span class="d">${e.date || ''}</span>
          </div>
        </div>
      `).join('');

      const posters = Array.from(grid.querySelectorAll('.poster img'));

      // IntersectionObserver: vezmi plakát nejblíž středu (rozumné chování při scrollu)
      const io = new IntersectionObserver(async (entries) => {
        // vyber viditelný s největším intersection ratio
        const vis = entries
          .filter(e => e.isIntersecting)
          .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];

        if(!vis) return;
        const img = vis.target;

        // u GIFů/PNG/JPG to funguje stejně (v rámci stejného originu)
        try{
          const {r,g,b} = await avgColorFromImage(img);
          setAmbientRGBA(r,g,b,0.30);
        }catch(_){
          // když by canvas odmítl číst (nečekám na GH Pages), nech default
        }
      }, { threshold: [0.45, 0.60, 0.75] });

      posters.forEach(img => {
        if (img.complete) io.observe(img);
        else img.addEventListener('load', () => io.observe(img), { once:true });
      });

      // start default ambient on first image (ať to není "mrtvé")
      const first = posters[0];
      if(first){
        try{
          if(!first.complete) await new Promise(r => first.addEventListener('load', r, { once:true }));
          const {r,g,b} = await avgColorFromImage(first);
          setAmbientRGBA(r,g,b,0.30);
        }catch(_){}
      }
    }

    load().catch(e => showErr(e.message));
  </script>
</body>
</html>
